# terraform-plan-comment

GitHub Action to post the output of `terraform plan` to a pull request comment.

## Features

- Generate a structured, "markdown-native" representation of the plan
  - Obtain a high-level overview via foldable sections
  - Do not lose _any_ information compared to the output of `terraform plan`
- Post the plan to pull requests as a "sticky comment"
- Run as a "native" JavaScript action rather than launching a Docker container
- Use with or without the Terraform wrapper script provided by
  [hashicorp/setup-terraform](https://github.com/hashicorp/setup-terraform)

## Usage

### With terraform

```yaml
- name: Setup terraform
  uses: hashicorp/setup-terraform@v3
- name: Initialize
  run: terraform init
- name: Plan
  run: terraform plan -out .planfile
- name: Post PR comment
  uses: borchero/terraform-plan-comment@v2
  with:
    token: ${{ github.token }}
    planfile: .planfile
```

### With terragrunt

```yaml
name: Plan

env:
  TG_NON_INTERACTIVE: "true"
  TG_NO_COLOR: "true"
  TG_ALL: "true"

jobs:
  plan:
    runs-on: ubuntu-latest
    container:
      image: alpine/terragrunt:tf1.12.1
    steps:
      - name: Initialize
        run: terragrunt init
      - name: Plan
        run: terragrunt plan -out .planfile
      - name: Post PR comment
        uses: borchero/terraform-plan-comment@v2
        env:
          # By default, terragrunt outputs plan including time, log level and message,
          # while terraform only outputs message. In order to keep consistency on output
          # for proper plan matching of this action, we need to limit this output to only
          # message
          TG_LOG_CUSTOM_FORMAT: "%msg(path=relative)"
        with:
          token: ${{ github.token }}
          planfile: .planfile
          terraform-cmd: terragrunt
```

### Example Comments

<details><summary><b>Collapsed</b></summary>

<img width="916" alt="Screenshot 2024-04-30 at 00 07 36" src="https://github.com/borchero/terraform-plan-comment/assets/22455425/b6d0e64c-1c9c-42b8-8060-c096922baa0a">

</details>

<details><summary><b>Expanded</b></summary>

<img width="699" alt="Screenshot 2024-04-30 at 00 08 22" src="https://github.com/borchero/terraform-plan-comment/assets/22455425/c91c319a-276d-4d2d-98a7-52bd24b64d4c">

</details>

## Parameters

```yaml
- uses: borchero/terraform-plan-comment@v2
  with:
    # GitHub token for API access (Required)
    token: ""

    # Path to the Terraform plan file (Required)
    planfile: ""

    # Command to execute the Terraform binary
    terraform-cmd: terraform

    # Directory where Terraform should be called
    working-directory: "."

    # Header for the PR comment
    header: üìù Terraform Plan

    # Skip comments for empty plans
    skip-empty: false

    # Skip PR comment creation entirely. When enabled, the plan will still be available in the step summary
    skip-comment: false
```

### `token` (required)

Required input parameter to access the GitHub API for posting a pull request comment. Can be provided as
`${{ github.token }}`, `${{ env.GITHUB_TOKEN }}` or some personal access token with appropriate permissions.

If using the workflow-provided token, make sure that your workflow/job has write-permissions to pull requests.

### `planfile` (required)

The path to the planfile generated by `terraform plan` which holds the information about which changes ought to be
applied.

### `terraform-cmd`

The command to execute to call the Terraform binary. Defaults to `terraform`. You likely don't need to augment this
unless `terraform` cannot be found in the `PATH`.

### `working-directory`

The directory where the Terraform binary ought to be called. Defaults to `$GITHUB_WORKSPACE` and _must_ be specified if
`terraform init` has been run in a different directory. Should be specified relative to `$GITHUB_WORKSPACE`.

<!-- prettier-ignore -->
> [!IMPORTANT]
> `planfile` must be specified relative to the working directory.

### `header`

The header that is used for the pull request comment posted by this action. Changing the default allows to distinguish
multiple Terraform runs: each sticky pull request comment is identified by its header.

### `skip-empty`

Whether to skip posting a pull request comment when no changes need to be performed. Defaults to `false`.

### `skip-comment`

Whether to skip posting a pull request comment entirely. When enabled, the plan will still be available in the step
summary.

## Outputs

This action provides the following output:

- `markdown`: The raw markdown output of the terraform plan
- `empty`: Whether the terraform plan contains any change or not
